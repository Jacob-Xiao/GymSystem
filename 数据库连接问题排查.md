# 数据库连接问题排查指南

## 错误信息
```
Access denied for user 'root'@'localhost' (using password: YES)
```

这个错误表示MySQL拒绝了连接请求，通常是因为密码不正确或配置问题。

## 解决步骤

### 步骤1：检查 .env 文件是否存在

在 `backend` 目录下，确认是否有 `.env` 文件。

**Windows 用户注意**：`.env` 文件可能被隐藏，需要在文件资源管理器中：
1. 点击"查看"
2. 勾选"隐藏的项目"

或者使用命令行查看：
```bash
cd backend
dir /a
```

### 步骤2：检查 .env 文件内容

`.env` 文件应该包含以下内容：

```env
PORT=3001
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=你的实际MySQL密码
DB_NAME=gym_management_system
JWT_SECRET=my-gym-secret-key-2024
```

**重要**：
- `DB_PASSWORD` 必须是你的 MySQL root 用户的实际密码
- 密码不要有引号（不要写成 `DB_PASSWORD="123456"`）
- 密码前后不要有空格
- 如果密码包含特殊字符，可能需要转义或使用引号

### 步骤3：验证 MySQL 密码

打开命令行或 MySQL 客户端，测试能否使用该密码登录：

```bash
mysql -u root -p
```

然后输入你的密码。如果无法登录，说明密码不正确。

### 步骤4：确认 MySQL 服务正在运行

**Windows**:
1. 按 `Win + R`，输入 `services.msc`
2. 查找 `MySQL` 服务
3. 确认状态为"正在运行"

或者使用命令行：
```bash
net start | findstr MySQL
```

**Mac/Linux**:
```bash
sudo service mysql status
```

### 步骤5：常见问题解决

#### 问题A：忘记 MySQL 密码

**Windows (使用MySQL Installer)**:
1. 打开 MySQL Installer
2. 选择"Reconfigure"（重新配置）
3. 在配置过程中可以重置 root 密码

**通用方法（重置密码）**:
```sql
-- 停止MySQL服务
-- 以跳过权限表方式启动MySQL
-- 然后执行：
ALTER USER 'root'@'localhost' IDENTIFIED BY '新密码';
FLUSH PRIVILEGES;
```

#### 问题B：.env 文件中的密码包含特殊字符

如果密码包含特殊字符（如 `@`, `#`, `$`, `%` 等），可能需要用引号包裹：

```env
DB_PASSWORD="your@password#123"
```

或者使用单引号：
```env
DB_PASSWORD='your@password#123'
```

#### 问题C：.env 文件格式错误

确保 `.env` 文件格式正确：
- 每行一个配置项
- 使用 `KEY=VALUE` 格式
- 等号前后可以有空格，但值中不要有多余空格
- 不要有空行导致的问题

#### 问题D：代码使用了默认密码

检查 `backend/config/database.js`，如果 `.env` 文件不存在，代码会使用默认密码 `12345678`：

```javascript
password: process.env.DB_PASSWORD || '12345678',
```

如果你的MySQL密码不是 `12345678`，必须创建 `.env` 文件并设置正确的密码。

### 步骤6：测试数据库连接

创建一个测试脚本来验证连接：

创建文件 `backend/test-db.js`:

```javascript
require('dotenv').config();
const mysql = require('mysql2/promise');

async function testConnection() {
  try {
    const connection = await mysql.createConnection({
      host: process.env.DB_HOST || 'localhost',
      user: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || '12345678',
      database: process.env.DB_NAME || 'gym_management_system'
    });
    
    console.log('✅ 数据库连接成功！');
    await connection.end();
  } catch (error) {
    console.error('❌ 数据库连接失败：');
    console.error('错误信息：', error.message);
    console.error('\n请检查：');
    console.error('1. .env 文件是否存在');
    console.error('2. DB_PASSWORD 是否正确');
    console.error('3. MySQL 服务是否运行');
    console.error('4. 数据库 gym_management_system 是否存在');
  }
}

testConnection();
```

运行测试：
```bash
cd backend
node test-db.js
```

### 步骤7：检查数据库是否存在

确保数据库 `gym_management_system` 已创建：

```bash
mysql -u root -p
```

```sql
SHOW DATABASES;
-- 应该能看到 gym_management_system

USE gym_management_system;
SHOW TABLES;
-- 应该能看到所有表
```

如果没有数据库，执行：
```sql
CREATE DATABASE gym_management_system;
-- 然后导入SQL文件
```

### 步骤8：重启后端服务

修改 `.env` 文件后，**必须重启后端服务**才能生效：

1. 停止当前运行的后端（Ctrl + C）
2. 重新启动：`npm start`

## 快速检查清单

- [ ] `.env` 文件存在于 `backend` 目录
- [ ] `.env` 文件中 `DB_PASSWORD` 设置了正确的MySQL密码
- [ ] 密码没有引号（除非密码包含特殊字符）
- [ ] MySQL 服务正在运行
- [ ] 可以使用 `mysql -u root -p` 登录MySQL
- [ ] 数据库 `gym_management_system` 已创建
- [ ] 修改 `.env` 后已重启后端服务

## 示例 .env 文件

**情况1：MySQL密码是 12345678**
```env
PORT=3001
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=12345678
DB_NAME=gym_management_system
JWT_SECRET=my-secret-key
```

**情况2：MySQL密码是 mypassword123**
```env
PORT=3001
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=mypassword123
DB_NAME=gym_management_system
JWT_SECRET=my-secret-key
```

**情况3：MySQL密码包含特殊字符（如 my@pass#123）**
```env
PORT=3001
DB_HOST=localhost
DB_USER=root
DB_PASSWORD="my@pass#123"
DB_NAME=gym_management_system
JWT_SECRET=my-secret-key
```

## 如果问题仍然存在

1. 查看后端终端的完整错误信息
2. 运行测试脚本 `node test-db.js` 查看详细错误
3. 检查MySQL错误日志
4. 尝试使用 MySQL Workbench 或 Navicat 等工具测试连接
